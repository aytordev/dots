name: "ðŸš€ Deploy"

# Solo se ejecuta cuando se hace push a main o manualmente
on:
  push:
    branches: [main]
  workflow_dispatch:

# ConfiguraciÃ³n de permisos
permissions:
  contents: read
  deployments: write
  statuses: write
  pull-requests: write

jobs:
  deploy:
    name: "ðŸš€ Deploy Configuration"
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: "ðŸ”½ Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "â¬‡ï¸ Install Nix"
        uses: DeterminateSystems/nix-installer-action@v9
        with:
          extra-conf: |
            experimental-features = nix-command flakes
            warn-dirty = false

      - name: "ðŸ”’ Setup Git User"
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: "ðŸ” Check for changes"
        id: changes
        run: |
          # Verificar si hay cambios en los archivos de configuraciÃ³n
          CHANGES=$(git diff --name-only origin/main HEAD -- '*.nix' '*.yaml' '*.sh' || true)
          if [ -z "$CHANGES" ]; then
            echo "No changes detected in configuration files, skipping deployment"
            echo "deploy_needed=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected, proceeding with deployment"
            echo "deploy_needed=true" >> $GITHUB_OUTPUT
          fi

      - name: "ðŸš€ Start Deployment"
        if: steps.changes.outputs.deploy_needed == 'true'
        uses: bobheadxi/deployments@v1
        id: deployment
        with:
          step: start
          token: ${{ secrets.GITHUB_TOKEN }}
          env: production
          ref: ${{ github.sha }}

      - name: "ðŸ—ï¸ Build and Deploy"
        if: steps.changes.outputs.deploy_needed == 'true'
        run: |
          echo "ðŸš€ Starting deployment..."
          
          # AquÃ­ irÃ­a la lÃ³gica de despliegue especÃ­fica
          # Por ejemplo, para un sistema NixOS podrÃ­a ser algo como:
          # nixos-rebuild switch --flake .#hostname
          
          # O para home-manager:
          # home-manager switch --flake .#user@hostname
          
          echo "âœ… Deployment completed successfully"

      - name: "âœ… Finish Deployment"
        if: always()
        uses: bobheadxi/deployments@v1
        with:
          step: finish
          token: ${{ secrets.GITHUB_TOKEN }}
          status: ${{ job.status }}
          env: production
          # Use the deployment ID from the start step if available; otherwise, generate a unique fallback ID
          # using the GitHub Actions run ID. This ensures we always have a valid deployment ID even if
          # the start step didn't run or failed to create a deployment.
          deployment_id: ${{ steps.deployment.outputs.deployment_id || format('deploy-{0}', github.run_id )}}
          desc: "Deployment ${{ job.status }}"

      - name: "ðŸ“Š Generate Deployment Report"
        if: always()
        run: |
          mkdir -p ${{ github.workspace }}/reports
          REPORT_PATH="${{ github.workspace }}/reports/deploy-report.md"
          
          echo "# ðŸš€ Deployment Report" > "$REPORT_PATH"
          echo "## ðŸ“… $(date)" >> "$REPORT_PATH"
          echo "### ðŸ”„ Changes" >> "$REPORT_PATH"
          
          if [ "${{ steps.changes.outputs.deploy_needed }}" = "true" ]; then
            echo "âœ… Configuration changes detected and deployed" >> "$REPORT_PATH"
            echo "\n### ðŸ“‹ Changed Files" >> "$REPORT_PATH"
            git diff --name-only HEAD^ HEAD -- '*.nix' '*.yaml' '*.sh' | sed 's/^/- /' >> "$REPORT_PATH"
          else
            echo "â„¹ï¸ No configuration changes detected, deployment skipped" >> "$REPORT_PATH"
          fi
          
          echo "\n### ðŸ” Build Info" >> "$REPORT_PATH"
          echo "- Nix Version: $(nix --version)" >> "$REPORT_PATH"
          echo "- Run URL: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID" >> "$REPORT_PATH"

      - name: "ðŸ“¤ Upload Deployment Report"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deploy-report
          path: ${{ github.workspace }}/reports/deploy-report.md
          retention-days: 7
