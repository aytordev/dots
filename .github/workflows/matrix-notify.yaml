name: "ğŸ”” Matrix Notifications"

on:
  workflow_run:
    workflows: ["validate-flake", "code-quality", "build-and-test", "deploy-nix-configs"]
    types: [completed]
  workflow_dispatch:
    inputs:
      test:
        description: 'Test message (optional)'
        required: false
        default: 'Test notification from workflow_dispatch'

jobs:
  notify:
    name: "Send notification to Matrix"
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion != 'skipped' &&
      (github.event.workflow_run.conclusion == 'failure' ||
       github.event.workflow_run.conclusion == 'success' ||
       github.event.workflow_run.conclusion == 'cancelled')
    steps:
      - name: Send notification
        uses: matrix-org/matrix-synapse-discover/notification/matrix@v1
        with:
          homeserver: "https://matrix.org"
          room-id: ${{ secrets.MATRIX_ROOM_ID }}
          access-token: ${{ secrets.MATRIX_ACCESS_TOKEN }}
          message: |
            ${{ github.event_name == 'workflow_dispatch' && format('ğŸ”” **Test Notification**
            ğŸ“ {0}
            ', github.event.inputs.test) || format('ğŸ”” **Workflow: {0}**
            ğŸ“¦ Repository: {1}
            âœ… Status: {2}
            ğŸ”— [View Run]({3}/{1}/actions/runs/{4})
            
            Commit: `{5}`
            Branch: `{6}`
            Triggered by: {7}', 
            github.workflow, github.repository, github.event.workflow_run.conclusion, 
            github.server_url, github.run_id, github.sha, github.ref_name, github.actor) }}
