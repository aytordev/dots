name: "🧹 Code Quality Analysis"

# Trigger conditions for the workflow
on:
  # Run on pushes to the main branch
  push:
    branches: [ main ]
  # Run on pull requests targeting the main branch
  pull_request:
    branches: [ main ]
  # Allow manual triggering from the GitHub UI
  workflow_dispatch:

# Configure permissions for the job
permissions:
  # Required to access repository contents
  contents: read
  # Required for CodeQL to upload results
  security-events: write
  # Required for actions/checkout to function
  actions: read

jobs:
  analyze-code-quality:
    name: "🔍 Analyze Code Quality"
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: "🔽 Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Required for change analysis

      - name: "⬇️ Install Nix"
        uses: DeterminateSystems/nix-installer-action@v9
        with:
          extra-conf: |
            experimental-features = nix-command flakes
            warn-dirty = false

      # Security analysis using GitHub's CodeQL
      - name: "🔒 Initialize CodeQL"
        uses: github/codeql-action/init@v3
        with:
          # Focus on Nix language analysis
          languages: nix
          # Include extended security and quality queries
          queries: security-extended,security-and-quality
          
      - name: "🔍 Run CodeQL Analysis"
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:nix"

      # Dependency analysis
      - name: "📦 Analyze Dependencies"
        run: |
          # List all unique packages used in the flake
          echo "🔍 Checking for outdated dependencies..."
          nix flake show --json | jq -r '.. | ."legacyPackages"? | select(. != null) | keys[]' | sort -u
          
          # Basic vulnerability check (can be enhanced with dedicated tools)
          echo "\n🔍 Checking for vulnerable packages..."
          # Note: This is a basic check - consider integrating dedicated vulnerability scanners
          nix flake check --no-build --no-write-lock-file || \
            echo "⚠️ Some dependencies may need attention (this is not necessarily an error)"

      # Code metrics collection
      - name: "📊 Calculate Code Metrics"
        run: |
          echo "📈 Calculating basic code metrics..."
          # Count total number of Nix files
          echo "Number of Nix files: $(find . -name '*.nix' | wc -l)"
          # Count total lines of Nix code
          echo "Lines of Nix code: $(find . -name '*.nix' -exec cat {} \; | wc -l)"

      # Secret scanning
      - name: "🔑 Check for Exposed Secrets"
        uses: gitleaks/gitleaks-action@v2
        with:
          # Path to the Gitleaks configuration file
          config-path: .github/gitleaks.toml

      # Generate final quality report
      - name: "📝 Generate Quality Report"
        if: always()
        run: |
          # Create a summary of all quality checks
          echo "# 📊 Code Quality Report" >> $GITHUB_STEP_SUMMARY
          
          # Security section
          echo "## Security Analysis" >> $GITHUB_STEP_SUMMARY
          echo "✅ CodeQL analysis completed" >> $GITHUB_STEP_SUMMARY
          echo "✅ Secret scanning completed" >> $GITHUB_STEP_SUMMARY
          
          # Dependencies section
          echo "## Dependencies" >> $GITHUB_STEP_SUMMARY
          echo "📦 $(nix flake show --json | jq -r '.. | ."legacyPackages"? | select(. != null) | keys[]' | sort -u | wc -l) unique packages detected" >> $GITHUB_STEP_SUMMARY
          
          # Code metrics section
          echo "## Code Metrics" >> $GITHUB_STEP_SUMMARY
          echo "📄 $(find . -name '*.nix' | wc -l) Nix files" >> $GITHUB_STEP_SUMMARY
          echo "📝 $(find . -name '*.nix' -exec cat {} \; | wc -l) total lines of Nix code" >> $GITHUB_STEP_SUMMARY
          
          # Final status
          echo "\n✨ Quality checks completed!" >> $GITHUB_STEP_SUMMARY

      # Upload results as workflow artifacts
      - name: "📤 Upload Quality Report"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          # Name for the uploaded artifact
          name: code-quality-report
          # Path to the report file
          path: ${{ github.workspace }}/code-quality-report.md
          # How long to keep the artifact (in days)
          retention-days: 7
